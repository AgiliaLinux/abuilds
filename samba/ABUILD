# ABUILD generated by mkpkg_generator.sh

pkgname=samba
pkgver=4.0.8
pkgbuild=2
arch=('auto')

shortdesc=("SMB file and print server")
longdesc=("Samba is an SMB file and print server for SMB and CIFS clients. It allows you to make file space or printers on a Samba host available to any PCs running SMB clients (such as PCs running Windows). If you have any SMB servers (such as Windows NT/2K Server), you may be able to replace them by or supplement them with Samba. One of Samba's big strengths is integration, so you can use it to tie together your Linux hosts and Windows PC clients.")

tags=('net-fs network')

source=(http://samba.org/samba/ftp/stable/${pkgname}-${pkgver}.tar.gz)

build_deps="talloc python docbook-xsl pkg-config libbsd db popt cups readline acl openldap krb5 linux-pam gamin gnutls dbus"
pkglist="smb_client wb_client"
adddep="smbclient libwbclient"
config_files="etc/conf.d/samba
etc/samba/smb.conf
etc/logrotate.d/samba
etc/pam.d/samba"


build() {
	go_src_dir
	set -e
	cd ${srcdir}/${pkgname}-${pkgver}/source3
	_samba4_idmap_modules=idmap_ad,idmap_rid,idmap_adex,idmap_hash,idmap_tdb2
	_samba4_pdb_modules=pdb_tdbsam,pdb_ldap,pdb_ads,pdb_smbpasswd,pdb_wbc_sam,pdb_samba4
	_samba4_auth_modules=auth_unix,auth_wbc,auth_server,auth_netlogond,auth_script,auth_samba4
	./configure --prefix=/usr \
              --libdir=/usr/lib$LIBDIRSUFFIX/ \
              --docdir=/usr/doc/${pkgname}-${pkgver} \
              --localstatedir=/var \
              --with-configdir=/etc/samba \
              --with-lockdir=/var/cache/samba \
              --with-piddir=/var/run \
              --with-sockets-dir=/var/run/samba \
              --with-logfilebase=/var/log/samba \
              --mandir=/usr/man \
              --enable-fhs \
              --with-pam \
              --with-pam_smbpass \
              --with-pammodulesdir=/lib${LIBDIRSUFFIX}/security \
	      --with-privatedir=/etc/samba/private \
              --with-ads \
              --with-acl-support \
              --with-libsmbclient \
	      --with-automount \
	      --with-acl-support=yes \
              --with-syslog \
              --enable-external-libtalloc \
	      --enable-cups \
	      --with-utmp \
	      --with-winbind \
	      --with-ldap \
	      --with-krb5 \
	      --with-shared-modules=${_samba4_idmap_modules},${_samba4_pdb_modules},${_samba4_auth_modules} \
              --enable-external-libtdb

	make -j${numjobs}
	set +e
}

smb_client() {
	pkgname=smbclient
	shortdesc=("Samba client libraries and utilities")
	longdesc=("This package contains libraries and utilities for basic samba client functionality. You don't need to use full samba package if you don't need to serve anybody.")
	adddep="cifs-utils libwbclient"
}

smb_client_prep() {
	set -e
	mkdir -p ${pkgdir}/usr/bin ${pkgdir}/usr/lib${LIBDIRSUFFIX}
	cd ${srcdir}/samba-${p_pkgver}/source3
	install -m755 bin/{smbclient,rpcclient,smbspool,smbtree,smbcacls,smbcquotas,smbget,net,nmblookup} ${pkgdir}/usr/bin/
      	for i in libnetapi* libsmbclient*;do
		cp  -a bin/${i}*.so* ${pkgdir}/usr/lib${LIBDIRSUFFIX}/
	done
	install -m755 script/smbtar ${pkgdir}/usr/bin/
	mkdir -p ${pkgdir}/usr/lib${LIBDIRSUFFIX}/cups/backend
	ln -sf /usr/bin/smbspool ${pkgdir}/usr/lib${LIBDIRSUFFIX}/cups/backend/smb
	mkdir -p ${pkgdir}/usr/include
	install -m644 include/libsmbclient.h ${pkgdir}/usr/include/
	install -m644 lib/netapi/netapi.h ${pkgdir}/usr/include/
	mkdir -p ${pkgdir}/usr/man/man{1,7,8}
	for man in smbspool net; do
		install -m644 ../docs/manpages/${man}.8 ${pkgdir}/usr/man/man8/
	done
	for man in rpcclient smbcacls smbclient smbcquotas smbget \
		smbtree smbtar nmblookup; do
		install -m644 ../docs/manpages/${man}.1 ${pkgdir}/usr/man/man1/
	done
	install -m644 ../docs/manpages/libsmbclient.7 ${pkgdir}/usr/man/man7/
	set +e


}

wb_client() {
	pkgname=libwbclient
	shortdesc="Samba Winbind client library"
}


wb_client_prep() {
	set -e
	cd ${srcdir}/samba-${pkgver}/source3
	mkdir -p ${pkgdir}/usr/lib${LIBDIRSUFFIX}
	for i in libwbclient* ; do
		cp -a bin/${i}*.so* ${pkgdir}/usr/lib${LIBDIRSUFFIX}
	done
	set +e
}

after_build() {
	set -e
	cd ${srcdir}/${pkgname}-${pkgver}/source3

	mkdir -p ${pkgdir}/var/log/samba
	mkdir -p ${pkgdir}/var/run/samba
	mkdir -p ${pkgdir}/etc/samba/private
	chmod 700 ${pkgdir}/etc/samba/private
	make DESTDIR=${pkgdir} install || exit 1
	chmod 644 ${pkgdir}/usr/include/*.h
	rm -rf ${pkgdir}/usr/var
	(cd script; cp installbin.sh i; cat i | sed 's/\/sbin\///' > installbin.sh)

	install -D -m755 ${filedir}/samba.init ${pkgdir}/etc/init.d/samba
	install -D -m644 ${filedir}/samba.conf.d ${pkgdir}/etc/conf.d/samba
  
	mkdir -p ${pkgdir}/etc/samba
	cat ../examples/smb.conf.default | \
		sed 's|log file = .*$|log file = /var/log/samba/log.%m|g' >${pkgdir}/etc/samba/smb.conf

  
	install -D -m644 ${filedir}/samba.logrotate ${pkgdir}/etc/logrotate.d/samba
	install -D -m644 ${filedir}/samba.pam ${pkgdir}/etc/pam.d/samba
	# spool directory
	install -d -m1777 ${pkgdir}/var/spool/samba
	sed -i 's|/usr/spool/samba|/var/spool/samba|g' ${pkgdir}/etc/samba/smb.conf
  
	# fix logrotate
	sed -i -e 's|log.%m|%m.log|g' ${pkgdir}/etc/samba/smb.conf
  
	# nsswitch libraries
	install -D -m755 ${srcdir}/samba-${pkgver}/nsswitch/libnss_wins.so ${pkgdir}/lib$LIBDIRSUFFIX/libnss_wins.so
	ln -s libnss_wins.so ${pkgdir}/lib$LIBDIRSUFFIX/libnss_wins.so.2
	install -D -m755 ${srcdir}/samba-${pkgver}/nsswitch/libnss_winbind.so ${pkgdir}/lib$LIBDIRSUFFIX/libnss_winbind.so
  
	# remove conflict files of smbclient
	for man in libsmbclient smbspool \
		umount.cifs mount.cifs net; do
		rm -f ${pkgdir}/usr/man/man8/${man}.8
	done
  
	for i in libnetapi* libwbclient* libsmbclient*;do
		rm -f ${pkgdir}/usr/lib$LIBDIRSUFFIX/$i
	done
  
	for bin in net \
		nmblookup rpcclient smbcacls smbclient \
		smbcquotas smbget smbspool smbtar smbtree; do
			rm -f ${pkgdir}/usr/bin/$bin
	done
  
	rm -f ${pkgdir}/usr/include/netapi.h
  
	for man in rpcclient smbcacls smbclient smbcquotas \
		smbtree smbtar nmblookup smbget; do
		rm -f ${pkgdir}/usr/man/man1/${man}.1
	done
  
	for man in tdbbackup tdbdump tdbtool; do
		rm -f ${pkgdir}/usr/man/man8/${man}.8
	done
  
	rm -f ${pkgdir}/usr/man/man7/libsmbclient.7
	rm -f ${pkgdir}/usr/include/libsmbclient.h

	# copy ldap example
	install -D -m644 ${srcdir}/samba-${pkgver}/examples/LDAP/samba.schema ${pkgdir}/usr/share/doc/samba/examples/LDAP/samba.schema
	set +e
}

