# ABUILD generated by mkpkg_generator.sh

pkgname=tcl
pkgver=8.6.0
pkgbuild=1
arch=("auto")

shortdesc=("tcl (Tool Command Language)")
longdesc=("Tcl, developed by Dr. John Ousterhout, is a simple to use text-based script language with many built-in features which make it especially nice for writing interactive scripts.")
tags=("dev-lang tcl")
source=("http://downloads.sourceforge.net/sourceforge/tcl/tcl${pkgver}-src.tar.gz")
build_deps="glibc-solibs"


before_build() {
  go_src_dir
  sed -i 's/#define DUPTRAVERSE_MAX_DEPTH 500/#define DUPTRAVERSE_MAX_DEPTH 5000/' \
    generic/regc_nfa.c
}


build() {
  go_src_dir
  cd unix

  BIT=""
  if [ "$ARCH" == "x86_64" ]; then
    BIT="--enable-64bit"
  fi
  ./configure --prefix=/usr --mandir=/usr/man --libdir=/usr/lib$LIBDIRSUFFIX --enable-threads $BIT
  make -j${numjobs}
  make test
}


after_build() {
  go_src_dir
  cd unix

  make INSTALL_ROOT="${pkgdir}" install install-private-headers
  find "${pkgdir}" -name '*.a' -type f -exec chmod 644 {} \;
  ln -sf tclsh8.6 "${pkgdir}/usr/bin/tclsh"

  # install license
  install -Dm644 ../license.terms "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
  # remove buildroot traces
  sed -i "s#${srcdir}#/usr/src#" "${pkgdir}"/usr/lib$LIBDIRSUFFIX/{tcl,tdbc1.0.0/tdbc,itcl4.0.0/itcl}Config.sh
}
