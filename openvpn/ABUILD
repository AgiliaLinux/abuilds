#ABUILD created by: khvalera, khvalera at narod.ru 
pkgname=openvpn
pkgver=2.3.2
easyrsaver=2.2.0_master
pkgbuild=1
arch=('auto')

shortdesc="An easy-to-use, robust, and highly configurable VPN (Virtual Private Network)"
source=("http://swupdate.openvpn.net/community/releases/${pkgname}-${pkgver}.tar.gz"
	"http://build.openvpn.net/downloads/releases/easy-rsa-${easyrsaver}.tar.gz n")
tags="network net-misc"
build_deps="gcc ccache openssl"
adddep="lzo openssl-solibs linux-pam"

BUILD_SYSTEM="autotools"
BUILD_WORD="LDFLAGS=\"${SLKLDFLAGS}\" CFLAGS=\"${SLKCFLAGS}\" CXXFLAGS=\"${SLKCFLAGS}\" ./configure"
BUILD_KEYS="--prefix=/usr \
--sysconfdir=/etc/openvpn \
--localstatedir=/var \
--libdir=/usr/lib${LIBDIRSUFFIX} \
--mandir=/usr/man \
--enable-password-save"

INSTALL_KEYS="DESTDIR=${pkgdir}"

after_build(){
 go_src_dir
 mkdir -p ${pkgdir}/etc/${pkgname}

 tar xf ${srcache}/easy-rsa-${easyrsaver}.tar.gz
 ( cd easy-rsa-${easyrsaver}
   ./configure --prefix=/usr --with-easyrsadir=/usr/share/openvpn/easy-rsa
   make install DESTDIR=${pkgdir} PREFIX=/usr/share/openvpn/easy-rsa
 )

 rm -f ${pkgdir}/usr/share/openvpn/easy-rsa/openssl-0.9.?.cnf
 ( cd sample
   cp -a sample-config-files ${pkgdir}/usr/share/openvpn/sample-config-files
   cp -a sample-keys ${pkgdir}/usr/share/openvpn/sample-keys
   cp -a sample-scripts ${pkgdir}/usr/share/openvpn/sample-scripts
 )

 cp -r contrib $pkgdir/usr/share/openvpn
 mv ${pkgdir}/usr/share/doc/openvpn/management-notes.txt ${pkgdir}/usr/doc/${pkgname}-${pkgver}
 rm -r ${pkgdir}/usr/share/doc/

 install -D -m755 ${filedir}/openvpn.init ${pkgdir}/etc/init.d/openvpn
 install -D -m644 ${filedir}/openvpn.conf ${pkgdir}/etc/conf.d/openvpn
 install -m755 ${filedir}/{up,down}.sh ${pkgdir}/etc/openvpn/

 install -D -m644 COPYING $pkgdir/usr/share/licenses/$pkgname/COPYING
}

