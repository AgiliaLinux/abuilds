# ABUILD generated by mkpkg_generator.sh

pkgname=vim
_basever=7.4
_srcver=74
pkgver=7.4.5
pkgbuild=1
arch=('auto')

shortdesc=('Vi IMproved')
longdesc=('Vim is an almost compatible version of the UNIX editor vi. Many new features have been added: multi level undo, command line history, filename completion, block operations, and more. Vim development is led by Bram Moolenaar. This package also contains the Exuberant Ctags program written by Darren Hiebert.')

tags=('app-editors console')

CTAGSVER=5.8
source=("ftp://ftp.vim.org/pub/vim/unix/vim-${_basever}.tar.bz2"
"http://citylan.dl.sourceforge.net/project/ctags/ctags/$CTAGSVER/ctags-$CTAGSVER.tar.gz")

build_deps='acl attr gpm glibc-solibs lftp rsync python perl'

PYVER=$(python -V 2>&1 | cut -f 2 -d' ' | cut -f 1-2 -d.)

config_files="usr/share/vim/vimrc"

config_vim() {
	CFLAGS="$SLKCFLAGS" \
		./configure \
		$* \
		--prefix=/usr \
		--enable-pythoninterp \
		--with-python-config-dir=/usr/lib${LIBDIRSUFFIX}/python$PYVER/config \
		--enable-perlinterp \
		--disable-tclinterp \
		--enable-multibyte \
		--enable-cscope \
		--with-features=huge \
		--enable-acl \
		--enable-gpm \
		--enable-perlinterp \
		--disable-rubyinterp \
		--disable-python3interp \
		--disable-luainterp \
		--disable-netbeans \
		--with-compiledby="AgiliaLinux"
}

build() {
	echo "VIM version: $pkgver"

	# Build CTAGS
	cd $srcdir/ctags-$CTAGSVER
	chown -R root:root .
	find . \( -perm 777 -o -perm 775 -o -perm 711 -o -perm 555 -o -perm 511 \) \
		-exec chmod 755 {} \; -o \
		\( -perm 666 -o -perm 664 -o -perm 600 -o -perm 444 -o -perm 440 -o -perm 400 \) \
		-exec chmod 644 {} \;
	CFLAGS="$SLKCFLAGS" LDFLAGS="$SLKLDFLAGS" \
		./configure \
		--prefix=/usr
	make -j${numjobs} || make
	install -Dm0755 ctags $pkgdir/usr/bin/ctags
	install -Dm0644 ctags.1 $pkgdir/usr/man/man1/ctags.1
	
	cd ${srcdir}/vim${_srcver}

	# Read vimrc and gvimrc from /etc/vim
	sed -i 's|^.*\(#define SYS_.*VIMRC_FILE.*"\) .*$|\1|' src/feature.h
	sed -i 's|^.*\(#define VIMRC_FILE.*"\) .*$|\1|' src/feature.h

	# Don't be fooled by /usr/include/libc.h. When found, vim thinks
	# this is NeXT, but it's actually just a file in dev-libs/9libs
	# This fixes bug 43885 (20 Mar 2004 agriffis)
	sed -i 's/ libc\.h / /' src/configure.in || die 'sed failed'

	# If there's no syntax update, create one:
	rm -rf runtime/syntax.orig
	cp -a runtime/syntax runtime/syntax.orig

	#You can fetch vim syntax updates from ftp.nluug.nl, but we'll use local snapshot instead
	#rsync -avzcP ftp.nluug.nl::Vim/runtime/syntax/ runtime/syntax/
	( cd runtime ; tar xf ${filedir}/syntax.tar.xz )
	diff -u -r --new-file runtime/syntax.orig runtime/syntax | gzip -9c > $startdir/vim-runtime-syntax.diff.gz
	rm -rf runtime/syntax
	mv runtime/syntax.orig runtime/syntax

	echo "Applying syntax updates"
	# Apply the syntax update:
	#zcat $startdir/vim-runtime-syntax.diff.gz | patch -p0 --verbose
	
	bzcat $filedir/vim-patches-${pkgver}.patch.bz2 | patch -p1 --verbose

	burn_patches

	(cd src && autoconf)

	# Configure vim. For gvim, there will be little other options
	config_vim --without-x --disable-gui
	make -j${numjobs} || make
	make install DESTDIR=$pkgdir
}


after_build() {
	cd ${srcdir}/vim${_srcver}

	rsync -lprvt $pkgdir/usr/share/man/ $pkgdir/usr/man/
	rm -r $pkgdir/usr/share/man

	cp -a runtime/vimrc_example.vim runtime/vimrc.new

	# Don't make backups in /var/spool/cron/*, which fixes "crontab -e":
	zcat $filedir/vim.vimrc.diff.gz | patch -p1 --verbose

	# Add patched vimrc to the package:
	cat runtime/vimrc.new > $pkgdir/usr/share/vim/vimrc

	# Fix manpage symlinks:
	if [ -d $pkgdir/usr/man ]; then
		( cd $pkgdir/usr/man
		for manpagedir in $(find . -type d -name "man*") ; do
			( cd $manpagedir
			for eachpage in $( find . -type l -maxdepth 1) ; do
				ln -s $( readlink $eachpage ).gz $eachpage.gz
				rm $eachpage
			done
			gzip -9 *.?
			)
		done
		)
	fi

	# Legacy binary links:
	for bin in ex rview rvim view eview evim ; do
	  ( cd $pkgdir/usr/bin ; rm -rf $bin )
	  ( cd $pkgdir/usr/bin ; ln -sf vim $bin )
	done
}

