# ABUILD generated by mkpkg_generator.sh

pkgname=nvidia-kernel-legacy173
pkgver=173.14.37
pkgbuild=7
arch=('auto')
provides=nvidia-kernel
KERNEL=${KERNEL:-$(uname -r)}
KERNELPATH=${KERNELPATH:-/usr/src/linux-${KERNEL}}
KERNPKGVERSION=`echo $KERNEL | sed -e "s/-/_/g"`
adddep="kernel==$KERNPKGVERSION"
FINAL_VER=${pkgver}_$(echo $KERNEL | tr - _)
pkgver_orig=${pkgver}
pkgver=$FINAL_VER

shortdesc=('nvidia-kernel-legacy173 (nvidia driver kernel module)')
longdesc=('This is the kernel module needed by the binary nvidia-driver.')
TARGET="x86"
tags=('drivers proprietary x11-drivers')
if [ "`uname -m`" = "x86_64" ] ; then
	TARGET="x86_64"
	pkgvariant=2
else
	pkgvariant=1
fi

source=("ftp://download.nvidia.com/XFree86/Linux-${TARGET}/${pkgver_orig}/NVIDIA-Linux-${TARGET}-${pkgver_orig}-pkg${pkgvariant}.run n")


build() {
	set -e
	set -x
	cd $srcdir
	sh $srcache/NVIDIA-Linux-${TARGET}-${pkgver_orig}-pkg${pkgvariant}.run --extract-only
	cd NVIDIA-Linux-${TARGET}-${pkgver_orig}-pkg${pkgvariant}/usr/src/nv/


#patch  -i $filedir/3.7_kernel.patch || exit 1
make 
#SYSSRC=/usr/lib/modules/${_kernver}/build/ module


#	SYSSRC=$KERNELPATH
	 make module -j${numjobs}

	mkdir -p $pkgdir/lib/modules/$KERNEL/kernel/drivers/video
	install -m 0664 nvidia.ko $pkgdir/lib/modules/$KERNEL/kernel/drivers/video/


	mkdir -p ${pkgdir}/install
	sed "s%@KERNEL@%$KERNEL%" $filedir/doinst.sh > $pkgdir/install/doinst.sh



	# This package conflicts with nouveau kernel module, so let's blacklist it:
	mkdir -p ${pkgdir}/etc/modprobe.d
	echo "blacklist nouveau" > ${pkgdir}/etc/modprobe.d/nouveau.conf
	
	set +e
	set +x

}
