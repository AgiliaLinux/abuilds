# ABUILD generated by mkpkg_generator.sh

pkgname=unrar
pkgver=5.0.8
pkgbuild=1
arch=("auto")

shortdesc=("unrar (unpacker for the RAR archive format)")
longdesc=("WinRAR is a powerful archive manager. Unrar is an opensource subset of RAR from rarlab that can uncompress RAR images. unrar home: http://www.rarlab.com/rar_add.htm")
tags=("console app-arch")
source=("http://www.rarlab.com/rar/unrarsrc-${pkgver}.tar.gz")
build_deps="cxxlibs glibc-solibs"
_libname=".so.${pkgver%.*.*}"

build() {
  unrar_make() {
    make -j${numjobs} CXXFLAGS="${CXXFLAGS}" STRIP=true "$@"
  }

  go_src_dir
  burn_patches
  sed -i -e "/libunrar/s:.so:${_libname}:" \
    -e "s:-shared:& -Wl,-soname -Wl,libunrar${_libname}:" \
    makefile || die
  unrar_make CXXFLAGS+=" -fPIC" lib
  ln -s libunrar${_libname} libunrar.so
  ln -s libunrar${_libname} libunrar.so.${pkgver}

  # The stupid code compiles a lot of objects differently if
  # they're going into a lib (-DRARDLL) or into the main app.
  # So for now, we can't link the main app against the lib.
  unrar_make clean
  unrar_make
}

after_build() {
  go_src_dir
  install -Dm755 unrar "${pkgdir}/usr/bin/unrar"
  mkdir -p ${pkgdir}/usr/lib$LIBDIRSUFFIX/
  cp -d libunrar.so* "${pkgdir}/usr/lib$LIBDIRSUFFIX/"
  install -Dm644 dll.hpp "${pkgdir}/usr/include/unrar/dll.hpp"
  # install license
  install -Dm644 license.txt "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}

